# Практика 3. Прикладной уровень

## Программирование сокетов. Веб-сервер

### А. Однопоточный веб-сервер (3 балла)
Вам необходимо разработать простой веб-сервер, который будет возвращать содержимое
локальных файлов по их имени. В этом задании сервер умеет обрабатывать только один запрос и
работает в однопоточном режиме. Язык программирования вы можете выбрать любой.
Требования:
- веб-сервер создает сокет соединения при контакте с клиентом (браузером) получает HTTP-запрос из этого соединения
- анализирует запрос, чтобы определить конкретный запрашиваемый файл
- находит запрошенный файл в своей локальной файловой системе
- создает ответное HTTP-сообщение, состоящее из содержимого запрошенного файла и предшествующих ему строк заголовков
- отправляет ответ через TCP-соединение обратно клиенту
- если браузер запрашивает файл, которого нет на веб-сервере, то сервер должен вернуть сообщение об ошибке «404 Not Found»

Ваша задача – разработать и запустить свой локальный веб-сервер, а затем проверить его
работу при помощи отправки запросов через браузер. Продемонстрируйте работу сервера, приложив скрины.

Скорее всего порт 80 у вас уже занят, поэтому вам необходимо использовать другой порт для
работы вашей программы.

Формат команды для запуска сервера:
```
<server.exe> server_port
```

#### Демонстрация работы
1) Запущенный сервер в консоли
![image](https://github.com/user-attachments/assets/a1a7751e-dc58-4a99-ba5e-fc5bb4077c0b)

2) Браузер с открытой страницей index.html (http://127.0.0.1:8080/)
![image](https://github.com/user-attachments/assets/dfd8a453-f921-48de-86f2-6ddcbebdad32)

3) Браузер с открытой страницей another.html (http://127.0.0.1:8080/another.html)
![image](https://github.com/user-attachments/assets/6c214c6e-20c2-415d-9997-b95051a2bdc6)

4) Браузер со страницей, которая не существует (например, nonexistent.html), показывающей ошибку 404
![image](https://github.com/user-attachments/assets/fdd844cd-fc9b-4666-9de2-45280ffa48a1)


### Б. Многопоточный веб-сервер (2 балла)
Реализуйте многопоточный сервер, который мог бы обслуживать несколько запросов
одновременно. Сначала создайте основной поток (процесс), в котором ваш модифицированный
сервер ожидает клиентов на определенном фиксированном порту. При получении запроса на
TCP-соединение от клиента он будет устанавливать это соединение через другой порт и
обслуживать запрос клиента в отдельном потоке. Таким образом, для каждой пары запрос-ответ
будет создаваться отдельное TCP-соединение в отдельном потоке.

#### Демонстрация работы
1) Запущенный сервер в консоли
![image](https://github.com/user-attachments/assets/75a533fd-e282-4391-8773-e0cd0abebc71)

2) Логи Работы
![image](https://github.com/user-attachments/assets/3259dda7-60ac-4daf-9429-c215d6ab4d66)

### В. Клиент (2 балла)
Вместо использования браузера напишите собственный HTTP-клиент для тестирования вашего
веб-сервера. Ваш клиент будет поддерживать работу с командной строкой, подключаться к
серверу с помощью TCP-соединения, отправлять ему HTTP-запрос с помощью метода GET и
отображать ответ сервера в качестве результата. Клиент должен будет в качестве входных
параметров принимать аргументы командной строки, определяющие IP-адрес или имя сервера,
порт сервера и имя файла на сервере. Продемонстрируйте работу клиента, приложив скрины. 

Формат команды для запуска клиента:
```
<client.exe> server_host server_port filename
```

#### Демонстрация работы
1) Запущенный клиент в консоли и вывод логов с существующем файлом и с несуществующем
![image](https://github.com/user-attachments/assets/2bd07a42-f786-445c-9562-530a72b0da3a)



### Г. Ограничение потоков сервера (3 балла)
Пусть ресурсы вашего сервера ограничены и вы хотите контролировать максимальное количество
потоков, с которыми может работать ваш многопоточный сервер одновременно. При запуске
сервер получает целочисленное значение `concurrency_level` из командной строки. Если сервер 
получает запрос от клиента, и при этом уже запущено максимальное количество потоков, то 
запрос от клиента блокируется (встает в очередь) и дожидается, пока не закончит работу 
один из запущенных потоков. После этого сервер может запустить новый поток для обработки 
запроса от клиента.

Формат команды для запуска сервера:
```
<server.exe> server_port concurrency_level
```
#### Демонстрация работы
1) Запущенный сервер в консоли и его часть логов
![image](https://github.com/user-attachments/assets/2b2d111e-8d0d-4737-9175-ebe6781c04bf)

2) Страницы работают (И пункте Б тоже)
![image](https://github.com/user-attachments/assets/7c01a901-5a25-4977-9fbe-855cb78c1058)


## Задачи

### Задача 1 (2 балла)
Голосовые сообщения отправляются от хоста А к хосту Б в сети с коммутацией пакетов в режиме
реального времени. Хост А преобразует на лету аналоговый голосовой сигнал в цифровой поток
битов, имеющий скорость $128$ Кбит/с, и разбивает его на $56$-байтные пакеты. Хосты А и Б
соединены одной линией связи, в которой скорость передачи данных равна $1$ Мбит/с, а задержка
распространения составляет $5$ мс. Как только хост А собирает пакет, он посылает его на хост Б,
который, в свою очередь, при получении всего пакета преобразует биты в аналоговый сигнал.
Сколько времени проходит с момента создания бита (из исходного аналогового сигнала на хосте
A) до момента его декодирования (превращения в часть аналогового сигнала на хосте Б)?

#### Решение
Для определения общего времени, которое проходит с момента создания бита до момента его декодирования, необходимо учесть следующие компоненты задержки:

**Время формирования пакета ($t_{\text{форм}}$):**
Время, необходимое для накопления достаточного количества битов голосового сигнала для создания одного пакета размером $L = 56 \text{ байт} = 448 \text{ бит}$ при скорости голосового потока $R_{\text{голос}} = 128 \text{ Кбит/с} = 128 \cdot 10^3 \text{ бит/с}$.
```math
t_{\text{форм}} = \frac{L}{R_{\text{голос}}} = \frac{448 \text{ бит}}{128 \cdot 10^3 \text{ бит/с}} = 0.0035 \text{ с} = 3.5 \text{ мс}
```

**Время передачи пакета ($t_{\text{перед}}$):**
Время, необходимое для отправки всех битов сформированного пакета ($L=448 \text{ бит}$) в линию связи со скоростью $R_{\text{линия}} = 1 \text{ Мбит/с} = 1 \cdot 10^6 \text{ бит/с}$.
```math
t_{\text{перед}} = \frac{L}{R_{\text{линия}}} = \frac{448 \text{ бит}}{1 \cdot 10^6 \text{ бит/с}} = 0.000448 \text{ с} = 0.448 \text{ мс}
```

**Время распространения сигнала ($t_{\text{распр}}$):**
Задержка прохождения сигнала по линии связи, данная по условию.
```math
t_{\text{распр}} = 5 \text{ мс}
```

**Полное время задержки ($T_{\text{общ}}$):**
Сумма всех вышеуказанных задержек.
```math
T_{\text{общ}} = t_{\text{форм}} + t_{\text{перед}} + t_{\text{распр}} = 3.5 \text{ мс} + 0.448 \text{ мс} + 5 \text{ мс} = 8.948 \text{ мс}
```

**Ответ:** С момента создания бита на хосте А до момента его декодирования на хосте Б проходит $8.948 \text{ мс}$.


### Задача 2 (2 балла)
Рассмотрим буфер маршрутизатора, где пакеты хранятся перед передачей их в исходящую линию
связи. В этой задаче вы будете использовать широко известную из теории массового
обслуживания (или теории очередей) формулу Литтла. Пусть $N$ равно среднему числу пакетов в
буфере плюс пакет, который передается в данный момент. Обозначим через $a$ скорость
поступления пакетов в буфер, а через $d$ – среднюю общую задержку (т.е. сумму задержек
ожидания и передачи), испытываемую пакетом. Согласно формуле Литтла $N = a \cdot d$.
Предположим, что в буфере содержится в среднем $10$ пакетов, а средняя задержка ожидания для
пакета равна $10$ мс. Скорость передачи по линии связи составляет $100$ пакетов в секунду.
Используя формулу Литтла, определите среднюю скорость поступления пакета в очередь,
предполагая, что потери пакетов отсутствуют.

#### Решение
Для решения задачи воспользуемся формулой Литтла: $N = a \cdot d$.

1.  **Определим среднее число пакетов в системе ($N$):**
    По условию, $N$ – это среднее число пакетов в буфере (в очереди, $N_q$) плюс пакет, который передается в данный момент (на обслуживании, $N_s$).
    Нам дано, что среднее число пакетов в буфере $N_q = 10$ пакетов.
    Пакет, который передается, – это 1 пакет.
    Следовательно, общее среднее число пакетов в системе:
    ```math
    N = N_q + N_s = 10 + 1 = 11 \text{ пакетов}
    ```

2.  **Определим среднюю общую задержку ($d$):**
    Общая задержка $d$ складывается из средней задержки ожидания в очереди ($d_q$) и средней задержки передачи ($d_{\text{перед}}$).
    Дано: средняя задержка ожидания $d_q = 10 \text{ мс} = 0.01 \text{ с}$.
    Скорость передачи по линии связи $R = 100 \text{ пакетов/с}$.
    Средняя задержка передачи одного пакета:
    ```math
    d_{\text{перед}} = \frac{1}{R} = \frac{1}{100 \text{ пакетов/с}} = 0.01 \text{ с} = 10 \text{ мс}
    ```
    Тогда средняя общая задержка:
    ```math
    d = d_q + d_{\text{перед}} = 10 \text{ мс} + 10 \text{ мс} = 20 \text{ мс} = 0.02 \text{ с}
    ```

3.  **Применим формулу Литтла для нахождения средней скорости поступления пакетов ($a$):**
    Из формулы $N = a \cdot d$ выразим $a$:
    ```math
    a = \frac{N}{d}
    ```
    Подставим найденные значения $N=11$ пакетов и $d=0.02$ с:
    ```math
    a = \frac{11 \text{ пакетов}}{0.02 \text{ с}} = 550 \text{ пакетов/с}
    ```

**Ответ:** Средняя скорость поступления пакетов в очередь составляет $550$ пакетов в секунду.

### Задача 3 (2 балла)
Рассмотрим рисунок.

<img src="images/task3.png" width=500 />

Предположим, нам известно, что на маршруте от сервера до клиента узким местом
является первая линия связи, скорость передачи данных по которой равна $R_S$ бит/с.
Допустим, что мы отправляем два пакета друг за другом от сервера клиенту, и другой
трафик на маршруте отсутствует. Размер каждого пакета составляет $L$ бит, а скорость
распространения сигнала по обеим линиям равна $d_{\text{распространения}}$.
1. Какова временная разница прибытия пакетов к месту назначения? То есть, сколько
времени пройдет от момента получения клиентом последнего бита первого пакета до
момента получения последнего бита второго пакета?
2. Теперь предположим, что узким местом является вторая линия связи (то есть $R_C < R_S$).
Может ли второй пакет находиться во входном буфере, ожидая передачи во вторую
линию? Почему? Если предположить, что сервер отправляет второй пакет, спустя $T$ секунд
после отправки первого, то каково должно быть минимальное значение $T$, чтобы очередь
во вторую линию связи была нулевая? Обоснуйте ответ.

#### Решение
1.  **Временная разница прибытия пакетов ($R_S < R_C$, первая линия - узкое место):**
    Если пакеты отправляются с сервера один за другим, то второй пакет начнет передаваться по первой (узкой) линии сразу после окончания передачи первого. Время передачи каждого пакета по этой линии равно $L/R_S$. Этот интервал между окончанием передачи первого пакета и окончанием передачи второго пакета по первой линии сохранится и при их прибытии к клиенту, так как вторая линия быстрее ($R_C > R_S$) и не будет вносить дополнительных задержек между пакетами.
    Следовательно, временная разница прибытия пакетов к месту назначения составит:
    ```math
    \Delta t = \frac{L}{R_S}
    ```

2.  **Условия для второй линии как узкого места ($R_C < R_S$):**
    *   **Может ли второй пакет находиться во входном буфере? Почему?**
        Да, второй пакет может находиться во входном буфере маршрутизатора.
        **Обоснование:** Первый пакет (P1) передается по первой линии за время $L/R_S$. По второй (более медленной) линии он будет передаваться дольше, за время $L/R_C$. Если второй пакет (P2) отправляется с сервера сразу после первого (т.е. его передача по первой линии начинается сразу после окончания передачи P1), он прибудет на маршрутизатор в тот момент, когда P1 еще не завершил передачу по второй линии (поскольку $L/R_S < L/R_C$ при $R_C < R_S$). Таким образом, P2 будет вынужден ожидать в буфере.

    *   **Минимальное значение $T$ для нулевой очереди:**
        Пусть $T$ — это дополнительная задержка, которую сервер выдерживает *после* того, как первый пакет (P1) был полностью передан по первой линии, и *перед* тем, как второй пакет (P2) начнет передаваться по первой линии.
        Момент времени, когда P1 полностью передан по второй линии и освобождает её (отсчитывая от момента начала отправки P1 с сервера):
        $t_{\text{P1\_освобождает\_R2}} = (L/R_S + d_{\text{распр1}}) + L/R_C$
        (время передачи P1 по первой линии + время распространения P1 по первой линии + время передачи P1 по второй линии).

        Второй пакет P2 начинает передаваться с сервера через $L/R_S + T$ после старта P1.
        Момент времени, когда P2 прибывает на маршрутизатор (и готов начать передачу по второй линии), отсчитывая от момента начала отправки P1 с сервера:
        $t_{\text{P2\_прибытие\_марш}} = (L/R_S + T) + L/R_S + d_{\text{распр1}}$
        (время передачи P1 по первой линии + доп. задержка $T$ + время передачи P2 по первой линии + время распространения P2 по первой линии).

        Для отсутствия очереди, P2 должен прибыть на маршрутизатор не ранее, чем P1 освободит вторую линию:
        $t_{\text{P2\_прибытие\_марш}} \geq t_{\text{P1\_освобождает\_R2}}$
        $(L/R_S + T + L/R_S + d_{\text{распр1}}) \geq (L/R_S + d_{\text{распр1}}) + L/R_C$
        Упрощая (сокращаем $L/R_S + d_{\text{распр1}}$ с обеих сторон):
        $L/R_S + T \geq L/R_C$
        Откуда минимальное значение дополнительной задержки $T$:
        ```math
        T_{\text{мин}} = \frac{L}{R_C} - \frac{L}{R_S}
        ```
        Это значение имеет смысл, если $R_C < R_S$ (тогда $T_{\text{мин}} > 0$). Если $R_C \ge R_S$, то $T_{\text{мин}} \le 0$, что означает отсутствие необходимости в дополнительной задержке (можно $T=0$).


### Задача 4 (4 балла)

<img src="images/task4.png" width=400 />

На рисунке показана сеть организации, подключенная к Интернету:
Предположим, что средний размер объекта равен $850000$ бит, а средняя скорость
запросов от браузеров этой организации к веб-серверам составляет $16$ запросов в секунду.
Предположим также, что количество времени, прошедшее с момента, когда внешний
маршрутизатор организации пересылает запрос HTTP, до момента, пока он не получит
ответ, равно в среднем три секунды. Будем считать, что общее среднее время ответа
равно сумме средней задержки доступа (то есть, задержки от маршрутизатора в
Интернете до маршрутизатора организации) и средней задержки в Интернете. Для
средней задержки доступа используем формулу $\dfrac{\Delta}{1 - \Delta \cdot B}$, 
где $\Delta$ – это среднее время, необходимое для отправки объекта по каналу связи, 
а B – частота поступления объектов в линию связи.
1. Найдите $\Delta$ (это среднее время, необходимое для отправки объекта по каналу связи).
2. Найдите общее среднее время ответа.
3. Предположим, что в локальной сети организации присутствует кэширующий
сервер. Пусть коэффициент непопадания в кэш равен $0.4$. Найдите общее время ответа.

#### Решение
Данные:
*   Средний размер объекта $S = 850000 \text{ бит}$.
*   Скорость канала доступа организации $R_{\text{доступа}} = 15 \text{ Мбит/с} = 15 \cdot 10^6 \text{ бит/с}$
*   Средняя скорость запросов от браузеров $B = 16 \text{ запросов/с}$.
*   Средняя задержка в Интернете (от внешнего маршрутизатора организации до веб-сервера и обратно, исключая канал доступа) $D_{\text{интернет}} = 3 \text{ секунды}$.
*   Формула для средней задержки на канале: $D_{\text{канала}} = \frac{\Delta}{1 - \rho}$, где $\rho = \Delta \cdot B_{\text{канала}}$ - интенсивность использования канала.

1.  **Найдем $\Delta$ (среднее время, необходимое для отправки объекта по каналу доступа):**
    ```math
    \Delta = \frac{S}{R_{\text{доступа}}} = \frac{850000 \text{ бит}}{15 \cdot 10^6 \text{ бит/с}} = \frac{85}{1500} \text{ с} = \frac{17}{300} \text{ с} \approx 0.05667 \text{ с}
    ```

2.  **Найдем общее среднее время ответа (без кэша):**
    Интенсивность использования канала доступа $\rho = \Delta \cdot B$:
    ```math
    \rho = \frac{17}{300} \text{ с/объект} \cdot 16 \text{ объектов/с} = \frac{272}{300} = \frac{68}{75} \approx 0.9067
    ```
    Средняя задержка на канале доступа $D_{\text{доступа}}$:
    ```math
    D_{\text{доступа}} = \frac{\Delta}{1 - \rho} = \frac{\frac{17}{300}}{1 - \frac{68}{75}} = \frac{\frac{17}{300}}{\frac{75-68}{75}} = \frac{\frac{17}{300}}{\frac{7}{75}} = \frac{17}{300} \cdot \frac{75}{7} = \frac{17}{4 \cdot 7} = \frac{17}{28} \text{ с} \approx 0.6071 \text{ с}
    ```
    Общее среднее время ответа $T_{\text{общ}}$:
    ```math
    T_{\text{общ}} = D_{\text{доступа}} + D_{\text{интернет}} = \frac{17}{28} \text{ с} + 3 \text{ с} \approx 0.6071 \text{ с} + 3 \text{ с} \approx 3.6071 \text{ с}
    ```

3.  **Найдем общее время ответа с кэширующим сервером:**
    Коэффициент непопадания в кэш (промаха) $m = 0.4$.
    Коэффициент попадания в кэш $h = 1 - m = 0.6$.
    Новая эффективная скорость запросов на канал доступа $B' = m \cdot B = 0.4 \cdot 16 = 6.4 \text{ запросов/с}$.
    Новая интенсивность использования канала доступа $\rho' = \Delta \cdot B'$:
    ```math
    \rho' = \frac{17}{300} \text{ с/объект} \cdot 6.4 \text{ объектов/с} = \frac{17 \cdot 6.4}{300} = \frac{108.8}{300} = \frac{136}{375} \approx 0.3627
    ```
    Новая средняя задержка на канале доступа (при промахе) $D'_{\text{доступа}}$:
    ```math
    D'_{\text{доступа}} = \frac{\Delta}{1 - \rho'} = \frac{\frac{17}{300}}{1 - \frac{136}{375}} = \frac{\frac{17}{300}}{\frac{375-136}{375}} = \frac{\frac{17}{300}}{\frac{239}{375}} = \frac{17}{300} \cdot \frac{375}{239} = \frac{17 \cdot 5}{4 \cdot 239} = \frac{85}{956} \text{ с} \approx 0.0889 \text{ с}
    ```
    Время ответа при промахе в кэше $T_{\text{промах}} = D'_{\text{доступа}} + D_{\text{интернет}}$:
    ```math
    T_{\text{промах}} = \frac{85}{956} \text{ с} + 3 \text{ с} \approx 0.0889 \text{ с} + 3 \text{ с} \approx 3.0889 \text{ с}
    ```
    Время ответа при попадании в кэш $T_{\text{попадание}} \approx 0 \text{ с}$ (пренебрежимо мало).
    Новое общее среднее время ответа с учетом кэша $T'_{\text{общ}}$:
    ```math
    T'_{\text{общ}} = h \cdot T_{\text{попадание}} + m \cdot T_{\text{промах}} = (0.6 \cdot 0 \text{ с}) + (0.4 \cdot T_{\text{промах}})
    ```
    ```math
    T'_{\text{общ}} = 0.4 \cdot (\frac{85}{956} + 3) \text{ с} \approx 0.4 \cdot 3.088912 \text{ с} \approx 1.2356 \text{ с}
    ```

**Ответ:**
1.  $\Delta = \frac{17}{300} \text{ с} \approx 0.0567 \text{ с}$.
2.  Общее среднее время ответа без кэша: $T_{\text{общ}} \approx 3.6071 \text{ с}$.
3.  Общее среднее время ответа с кэшем: $T'_{\text{общ}} \approx 1.2356 \text{ с}$.
