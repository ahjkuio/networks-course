# Практика 2. Rest Service

## Программирование. Rest Service. Часть I

### Задание А (3 балла)
Создайте простой REST сервис, в котором используются HTTP операции GET, POST, PUT и DELETE.
Предположим, что это сервис для будущего интернет-магазина, который пока что умеет 
работать только со списком продуктов. У каждого продукта есть поля: `id` (уникальный идентификатор),
`name` и `description`. 

Таким образом, json-схема продукта (обозначим её `<product-json>`):

```json
{
  "id": 0,
  "name": "string",
  "description": "string"
}
```

Данные продукта от клиента к серверу должны слаться в теле запроса в виде json-а, **не** в параметрах запроса.

Ваш сервис должен поддерживать следующие операции:
1. Добавить новый продукт. При этом его `id` должен сгенерироваться автоматически
   - `POST /product`
   - Схема запроса:
     ```json
     {
       "name": "string",
       "description": "string"
     }
     ```
   - Схема ответа: `<product-json>` (созданный продукт)
2. Получить продукт по его id
   - `GET /product/{product_id}`
   - Схема ответа: `<product-json>`
3. Обновить существующий продукт (обновляются только те поля продукта, которые были переданы в теле запроса)
   - `PUT /product/{product_id}`
   - Схема запроса: `<product-json>` (некоторые поля могут быть опущены)
   - Схема ответа: `<product-json>` (обновлённый продукт)
4. Удалить продукт по его id
   - `DELETE /product/{product_id}`
   - Схема ответа: `<product-json>` (удалённый продукт)
5. Получить список всех продуктов 
   - `GET /products`  
   - Схема ответа:
     ```
     [ 
       <product-json-1>,
       <product-json-2>, 
       ... 
     ]
     ```

Предусмотрите возвращение ошибок (например, если запрашиваемого продукта не существует).

Вы можете положить код сервиса в отдельную директорию рядом с этим документом.

### Задание Б (3 балла)
Продемонстрируйте работоспособность сервиса с помощью программы Postman
(https://www.postman.com/downloads) и приложите соответствующие скрины, на которых указаны
запросы и ответы со стороны сервиса для **всех** его операций.

#### Демонстрация работы
1) Добавление нового продукта (POST /product)
![1](https://github.com/user-attachments/assets/b9ed83eb-1d87-40c8-a04e-a47a7a2af6ff)

2) Получение существующего продукта по `id` (GET /product/1)
![2](https://github.com/user-attachments/assets/98c6eac7-b422-4560-9867-044386f05a2c)

3) Получение списка продуктов (GET /products)
![3](https://github.com/user-attachments/assets/fa90cca7-57b0-4585-ba70-92dee48f2869)

4) Обновление названия и описания объекта (PUT /product/1)
![4](https://github.com/user-attachments/assets/34e3809e-608f-4dbf-b691-183c5b8b2d9a)
![4 1](https://github.com/user-attachments/assets/97c43baa-ed97-480d-ba73-c11a87b0e565)

5) Удаление продукта (DELETE /product/1)
![5](https://github.com/user-attachments/assets/68e065e9-6f53-414a-b3d9-d1d93a238458)
![5 1](https://github.com/user-attachments/assets/f1dd1664-01ae-4397-b1c1-70b150a2600a)


### Задание В (4 балла)
Пусть ваш продукт также имеет иконку (небольшую картинку). Формат иконки (картинки) может
быть любым на ваш выбор. Для простоты будем считать, что у каждого продукта картинка одна.

Добавьте две новые операции:
1. Загрузить иконку:
   - `POST product/{product_id}/image`
   - Запрос содержит бинарный файл — изображение  
     <img src="images/post-image.png" width=500 />
2. Получить иконку:
   - `GET product/{product_id}/image`
   - В ответе передаётся только сама иконка  
     <img src="images/get-image.png" width=500 />

Измените операции в Задании А так, чтобы теперь схема продукта содержала сведения о загруженной иконке, например, имя файла или путь:
```json
"icon": "string"
```

#### Демонстрация работы
1) Добавим продукту лого
![6](https://github.com/user-attachments/assets/f190ead0-700c-4355-aa2b-15990e7a3960)
![6 1](https://github.com/user-attachments/assets/b382ea3e-7b4f-4e0a-9511-f1fdecccecb3)

---

_(*) В последующих домашних заданиях вам будет предложено расширить функционал данного сервиса._

## Задачи

### Задача 1 (2 балла)
Общая (сквозная) задержка прохождения для одного пакета от источника к приемнику по пути,
состоящему из $N$ соединений, имеющих каждый скорость $R$ (то есть между источником и
приемником $N - 1$ маршрутизатор), равна $d_{\text{сквозная}} = N \dfrac{L}{R}$
Обобщите данную формулу для случая пересылки количества пакетов, равного $P$.

#### Решение
Рассмотрим время, необходимое для доставки всех $P$ пакетов.
Время передачи одного пакета размером $L$ по одному каналу со скоростью $R$ составляет $L/R$.

Первый пакет достигает приемника за время $T_1 = N \cdot \dfrac{L}{R}$, так как он проходит $N$ каналов последовательно (принцип store-and-forward).

Каждый последующий пакет ($2$-й, $3$-й, ..., $P$-й) прибывает на $L/R$ позже предыдущего из-за эффекта конвейера: как только первый пакет освобождает первый канал, второй пакет может начать по нему передаваться, и так далее.
Таким образом, последний, $P$-й пакет, прибудет на $(P-1) \cdot \dfrac{L}{R}$ позже первого пакета.

Общее время $T_P$ для доставки всех $P$ пакетов складывается из времени доставки первого пакета и дополнительного времени для оставшихся $(P-1)$ пакетов:
$$ T_P = T_1 + (P-1) \dfrac{L}{R} $$
Подставляя $T_1 = N \dfrac{L}{R}$:
$$ T_P = N \dfrac{L}{R} + (P-1) \dfrac{L}{R} = (N + P - 1) \dfrac{L}{R} $$

**Ответ:** Общая сквозная задержка для $P$ пакетов: $d_{\text{сквозная}}(P) = (N + P - 1) \dfrac{L}{R}$.

### Задача 2 (2 балла)
Допустим, мы хотим коммутацией пакетов отправить файл с хоста A на хост Б. Между хостами установлены три
последовательных канала соединения со следующими скоростями передачи данных:
$R_1 = 200$ Кбит/с, $R_2 = 3$ Мбит/с и $R_3 = 2$ Мбит/с.
Сколько времени приблизительно займет передача на хост Б файла размером $5$ мегабайт?
Как это время зависит от размера пакета?

#### Решение
Определим скорости: $R_1 = 200 \text{ Кбит/с}$, $R_2 = 3000 \text{ Кбит/с}$, $R_3 = 2000 \text{ Кбит/с}$.
Размер файла: $F = 5 \text{ МБ} = 40000 \text{ Кбит}$.

**Приблизительное время:**
Время передачи в основном определяется самым медленным каналом ($R_1 = 200 \text{ Кбит/с}$):
$T_{\text{прибл.}} \approx F/R_1 = 40000/200 = 200 \text{ секунд}$.

**Зависимость от размера пакета $L$:**
При передаче пакетами, общее время $T$ складывается из времени прохождения всего файла через первый (самый медленный) канал и времени прохождения последнего пакета через оставшиеся два канала:
$T = \dfrac{F}{R_1} + \dfrac{L}{R_2} + \dfrac{L}{R_3} = 200 + L(\frac{1}{3000} + \frac{1}{2000}) = 200 + \dfrac{L}{1200}$ секунд (где $L$ в Кбитах).
Таким образом, время линейно растет с увеличением $L$. Чем меньше $L$, тем $T$ ближе к 200 с, так как задержка на последних двух участках для последнего пакета будет меньше.

### Задача 3 (2 балла)
Предположим, что пользователи делят канал с пропускной способностью $2$ Мбит/с. Каждому
пользователю для передачи данных необходима скорость $100$ Кбит/с, но передает он данные
только в течение $20$ процентов времени использования канала. Предположим, что в сети всего $60$
пользователей. А также предполагается, что используется сеть с коммутацией пакетов. Найдите
вероятность одновременной передачи данных $12$ или более пользователями.

#### Решение
Пусть $X$ — число пользователей, одновременно передающих данные. $X \sim \text{Bin}(n=60, p=0.2)$.
Мы ищем $P(X \ge 12) = 1 - P(X \le 11)$.
Вычислим $P(X \le 11)$:
\[ P(X \le 11) = \sum_{k=0}^{11} C_{60}^k \cdot (0.2)^k \cdot (0.8)^{60-k} \]
Используя калькулятор, получаем $P(X \le 11) \approx 0.4486$.
Тогда, искомая вероятность:
\[ P(X \ge 12) \approx 1 - 0.4486 = 0.5514 \]
(Информация о пропускной способности канала и скорости на пользователя не влияет на расчет этой вероятности).

### Задача 4 (2 балла)
Пусть файл размером $X$ бит отправляется с хоста А на хост Б, между которыми три линии связи и
два коммутатора. Хост А разбивает файл на сегменты по $S$ бит каждый и добавляет к ним
заголовки размером $80$ бит, формируя тем самым пакеты длиной $L = 80 + S$ бит. Скорость
передачи данных по каждой линии составляет $R$ бит/с. Загрузка линий мала, и очередей пакетов
нет. При каком значении $S$ задержка передачи файла между хостами А и Б будет минимальной?
Задержкой распространения сигнала пренебречь.

#### Решение
**1. Определяем параметры и функцию задержки:**
*   Размер файла: $X$ бит.
*   Размер сегмента данных: $S$ бит.
*   Размер заголовка: $H = 80$ бит.
*   Размер пакета: $L = S + H = S + 80$ бит.
*   Количество каналов: $N_{hops} = 3$.
*   Скорость канала: $R$ бит/с.

Число пакетов $P = X/S$. (Используем допущение $P \approx X/S$ для дифференцирования, предполагая $S$ достаточно мало по сравнению с $X$, или $X$ кратно $S$).
Общая задержка (из Задачи 1): $T(S) = (N_{hops} + P - 1) \dfrac{L}{R}$.
Подставляя значения:
\[ T(S) = \left( 3 + \dfrac{X}{S} - 1 \right) \dfrac{S+80}{R} = \left( 2 + \dfrac{X}{S} \right) \dfrac{S+80}{R} \]
Мы хотим минимизировать $T(S)$ по $S > 0$. Константа $1/R$ не влияет на точку минимума, поэтому минимизируем $f(S) = (2S+160) + (X + 80X/S) = 2S + X + 160 + \dfrac{80X}{S}$.

**2. Поиск минимума:**
Берем производную по $S$:
\[ f'(S) = \dfrac{d}{dS} \left( 2S + X + 160 + 80XS^{-1} \right) = 2 - \dfrac{80X}{S^2} \]
Приравниваем производную к нулю:
\[ 2 - \dfrac{80X}{S^2} = 0 \implies 2S^2 = 80X \implies S^2 = 40X \]
Поскольку $S > 0$, получаем $S_{opt} = \sqrt{40X}$.

**3. Проверка типа экстремума:**
Вторая производная:
\[ f''(S) = \dfrac{d}{dS} \left( 2 - 80XS^{-2} \right) = 160XS^{-3} = \dfrac{160X}{S^3} \]
Так как $X > 0$ и $S > 0$, то $f''(S_{opt}) > 0$, что подтверждает, что $S_{opt} = \sqrt{40X}$ является точкой локального минимума.

**4. Ответ и замечания:**
Оптимальный размер сегмента данных, минимизирующий задержку (при сделанных допущениях):
\[ S = \sqrt{40X} \text{ бит} \]

### Задание 5 (2 балла)
Рассмотрим задержку ожидания в буфере маршрутизатора. Обозначим через $I$ интенсивность
трафика, то есть $I = \dfrac{L a}{R}$.
Предположим, что для $I < 1$ задержка ожидания вычисляется как $\dfrac{I \cdot L}{R (1 – I)}$. 
1. Напишите формулу для общей задержки, то есть суммы задержек ожидания и передачи.
2. Опишите зависимость величины общей задержки от значения $\dfrac{L}{R}$.

#### Решение
**Часть 1: Формула для общей задержки**

Дано:
*   Задержка ожидания: $d_{\text{ожидания}} = \dfrac{I \cdot L}{R (1 – I)}$
*   Интенсивность трафика: $I = \dfrac{La}{R}$ (где $a$ – средняя скорость поступления пакетов)

Общая задержка $d_{\text{общая}}$ есть сумма задержки ожидания и задержки передачи ($d_{\text{передачи}} = L/R$):
\[ d_{\text{общая}} = \dfrac{I L}{R (1 – I)} + \dfrac{L}{R} \]
Вынося $L/R$ за скобки:
\[ d_{\text{общая}} = \dfrac{L}{R} \left( \dfrac{I}{1-I} + 1 \right) = \dfrac{L}{R} \left( \dfrac{I + 1 - I}{1-I} \right) = \dfrac{L}{R(1-I)} \]
Подставляя $I = La/R$, получаем зависимость от $L, R, a$:
\[ d_{\text{общая}} = \dfrac{L}{R - La} \]
Или, выражая через $x = L/R$ (время передачи пакета):
\[ d_{\text{общая}}(x) = \dfrac{x}{1 - ax} \quad (\text{при условии } ax < 1, \text{ т.е. } I < 1) \]

**Часть 2: Описание зависимости общей задержки от значения $L/R$**

Обозначим $x = L/R$. Зависимость $d_{\text{общая}}(x) = \dfrac{x}{1 - ax}$ является **нелинейной**.

1.  **При малых $L/R$ (т.е. $x \to 0$):** Интенсивность $I=ax$ также мала. $d_{\text{общая}}(x) \approx x = L/R$.
    Общая задержка стремится к времени передачи пакета, так как очередь минимальна.

2.  **При $L/R$ таком, что интенсивность $I = a(L/R)$ приближается к 1 (т.е. $ax \to 1^{-}$):**
    Знаменатель $(1-ax)$ стремится к нулю, и $d_{\text{общая}}(x) \to +\infty$.
    Задержка резко возрастает из-за перегрузки канала и неограниченного роста очереди.

В целом, с увеличением $L/R$ (при фиксированном $a$), общая задержка $d_{\text{общая}}$ растет. Рост становится особенно резким, когда загрузка канала $I$ приближается к 100%.
